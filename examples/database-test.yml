name: Database Test Workflow
version: "1.0"
description: Example workflow demonstrating database query functionality

variables:
  db_host: "{{env.DB_HOST}}"
  db_user: "{{env.DB_USER}}"
  db_password: "{{env.DB_PASSWORD}}"
  db_name: "{{env.DB_NAME}}"
  # Alternative: use DSN directly
  # db_dsn: "{{env.DB_DSN}}"

steps:
  - name: Query users from database (using individual parameters)
    description: Execute a SELECT query using individual connection parameters
    request:
      protocol: db
      db:
        type: postgres
        host: "{{db_host}}"
        port: 5432
        database: "{{db_name}}"
        username: "{{db_user}}"
        password: "{{db_password}}"
        ssl_mode: disable
      query: "SELECT id, name, email FROM users LIMIT 10"
    capture:
      first_user_id: "$[0].id"
      first_user_name: "$[0].name"
      user_count: "$.length"
    validate:
      - json: "$.length"
        greater: 0
      - json: "$[0].id"
        type: number

  - name: Query users using DSN
    description: Execute a SELECT query using DSN connection string
    request:
      protocol: db
      db:
        type: postgres
        dsn: "host={{db_host}} port=5432 user={{db_user}} password={{db_password}} dbname={{db_name}} sslmode=disable"
      query: "SELECT id, name, email FROM users LIMIT 10"
    capture:
      first_user_id: "$[0].id"
      first_user_name: "$[0].name"
      user_count: "$.length"
    validate:
      - json: "$.length"
        greater: 0

  - name: Query specific user
    description: Query a user by ID using captured variable
    request:
      protocol: db
      db:
        type: postgres
        host: "{{db_host}}"
        port: 5432
        database: "{{db_name}}"
        username: "{{db_user}}"
        password: "{{db_password}}"
        ssl_mode: disable
      query: "SELECT * FROM users WHERE id = {{first_user_id}}"
    validate:
      - json: "$.id"
        equals: "{{first_user_id}}"
      - json: "$.name"
        type: string

  - name: Count users using DSN from environment
    description: Count total number of users using DSN from environment variable
    request:
      protocol: db
      db:
        type: postgres
        dsn: "{{env.DB_DSN}}"
      query: "SELECT COUNT(*) as total FROM users"
    capture:
      total_users: "$.total"
    validate:
      - json: "$.total"
        type: number
        greater: 0

