name: "HTTPBin Basic Flow"
version: "1.0"

variables:
  base_url: "https://httpbin.org"
  saved_request_id: "{{faker.uuid}}"

steps:
  - name: "Получить данные запроса"
    request:
      method: "GET"
      url: "{{base_url}}/get?source=stepwise&request_id={{saved_request_id}}"
    validate:
      - status: 200
      - json: "$.args.source"
        equals: "stepwise"
      - json: "$.args.request_id"
        equals: "{{saved_request_id}}"
      - json: '$.headers["User-Agent"]'
        type: "string"
    capture:
      saved_client_ip: "$.origin"
      saved_user_agent: '$.headers["User-Agent"]'

  - name: "Отправить JSON с данными клиента"
    request:
      method: "POST"
      url: "{{base_url}}/post"
      headers:
        Content-Type: "application/json"
      body:
        request_id: "{{saved_request_id}}"
        client_ip: "{{saved_client_ip}}"
        user_agent: "{{saved_user_agent}}"
    validate:
      - status: 200
      - json: "$.json.request_id"
        equals: "{{saved_request_id}}"
      - json: "$.json.client_ip"
        equals: "{{saved_client_ip}}"
      - json: '$.headers["Content-Type"]'
        contains: "application/json"
    capture:
      saved_post_echo: "$.json"

  # Проверяем, что ранее сохранённые значения корректно подставляются в новом запросе
  - name: "Проверить echo-эндпоинт"
    request:
      method: "GET"
      url: "{{base_url}}/anything/{{saved_request_id}}"
      headers:
        X-Origin-IP: "{{saved_client_ip}}"
    validate:
      - status: 200
      - json: "$.url"
        contains: "{{saved_request_id}}"
      - json: '$.headers["X-Origin-Ip"]'
        equals: "{{saved_client_ip}}"
      - json: "$.method"
        equals: "GET"